name: Update GitHub Language Stats

on:
  workflow_dispatch:

permissions:
  contents: write 

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gnuplot

      - name: Build languages.json (convert bytes â†’ LOC)
        env:
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          repos=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/users/DucMinhNgo/repos?per_page=200" \
            | jq -r '.[].full_name')

          echo "{}" > languages.json

          for repo in $repos; do
            curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$repo/languages" \
            | jq -r 'to_entries[] | "\(.key) \(.value)"'
          done \
          | awk '{ bytes[$1]+=$2 } END { 
              print "{"; 
              n=0;
              for (lang in bytes) { 
                loc=int(bytes[lang] / 50); 
                printf "%s \"%s\": %d", (n++?",":""), lang, loc 
              } 
              print "}" 
          }' \
          | jq --sort-keys . > languages.json



      - name: Generate LANGS.md table (LOC)
        run: |
          echo "| Language | Lines of Code |" > LANGS.md
          echo "|----------|----------------|" >> LANGS.md
          jq -r 'to_entries[] | "| \(.key) | \(.value) |"' languages.json >> LANGS.md


      - name: Generate SVG chart (LOC)
        run: |
          jq -r 'to_entries[] | "\(.key) \(.value)"' languages.json > data.txt

          gnuplot -e "
            set terminal svg size 900,600;
            set output 'LANGS.svg';
            set boxwidth 0.5;
            set style fill solid;
            set xtics rotate by -40;
            set ylabel 'Lines of Code';
            set grid ytics;
            plot 'data.txt' using 2:xtic(1) with boxes title 'Language LOC';
          "

      - name: Update README.md
        run: |
          awk -v block="$(cat LANGS.md)" '
            /<!-- LANG-TABLE-START -->/ { print; print block; flag=1; next }
            /<!-- LANG-TABLE-END -->/   { flag=0; print; next }
            !flag
          ' README.md > README.new

          mv README.new README.md


      - name: Commit & Push
        run: |
          git config --global user.name 'DucMinhNgo' || true
          git config --global user.email 'ducminhngo1998@gmail.com' || true
          git add .
          git commit -m "Update languages data" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
